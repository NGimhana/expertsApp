<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phase 2: Comprehensibility Ranking</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 40px;
            background-color: #f9f9f9;
        }

        #feedback-modal button:hover {
            color: #f44336;
        }

        .instructions {
            margin-bottom: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .rank-section {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .position-title {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .cards-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
        }

        .card {
            min-width: 100px;
            padding: 8px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: grab;
            font-size: 14px;
            flex-shrink: 0;
        }

        .card.dragging {
            opacity: 0.5;
        }

        .preview-area {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .code-box {
            background: #2d2d2d;
            color: #ccc;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            flex: 1 1 45%;
            min-width: 300px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
        }

        .keyword {
            color: #569CD6;
            font-weight: bold;
        }

        .type {
            color: #4EC9B0;
        }

        .function {
            color: #DCDCAA;
        }

        .literal {
            color: #B5CEA8;
        }

        .string {
            color: #CE9178;
        }

        .comment {
            color: #6A9955;
            font-style: italic;
        }

        .number {
            color: #B5CEA8;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #bbb;
            margin-bottom: 10px; /* Add margin for spacing */
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .cards-container {
            background: linear-gradient(to right, #eaffea, #fff5f5);
            padding: 10px;
            border-radius: 6px;
        }


        /* Base style for code snippet area */
        /* Snippet Header */
        .snippet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e6e6e6;
            color: #333;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid #ccc;
            margin-top: 20px;
        }

        /* Light Theme */
        .code-light .snippet-header {
            background: #f8f8f8;
            color: #222;
            border-color: #ddd;
        }

        .code-light .code-box {
            background-color: #f9f9f9;
            color: #333;
        }

        /* Dark Theme */
        .code-dark .snippet-header {
            background: #2d2d2d;
            color: #ccc;
            border-color: #444;
        }

        .code-dark .code-box {
            background-color: #2d2d2d;
            color: #ccc;
        }

        /* Shared Code Box Styling */
        .code-box {
            padding: 15px;
            border-radius: 0 0 8px 8px;
            overflow-x: auto;
            flex: 1 1 45%;
            min-width: 300px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            border: 1px solid #ccc;
            border-top: none;
            margin-bottom: 10px;
        }

        /* Toggle Button Styled Like Phase 1 */
        #code-theme-toggle {
            padding: 6px 12px;
            font-size: 14px;
            background-color: #333;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        #code-theme-toggle:hover {
            background-color: #555;
        }


        /* for preview area*/
        /* === Code Snippet Preview Area === */

        .preview-area {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .snippet-preview-box {
            flex: 1 1 45%;
            min-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            border: 1px solid #ddd;
        }

        /* Snippet header inside preview box */
        .snippet-header {
            background-color: #f5f5f5;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid #ccc;
        }

        /* Code container */
        .code-box {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            padding: 15px;
            font-size: 14px;
            color: #333;
            background-color: #f9f9f9;
        }

        /* === Dark Mode Support === */

        body.dark-mode .snippet-preview-box {
            background-color: #2e2e2e;
            border-color: #555;
        }

        body.dark-mode .snippet-header {
            background-color: #1f1f1f;
            color: #fff;
            border-bottom: 1px solid #444;
        }

        body.dark-mode .code-box {
            background-color: #1c1c1c;
            color: #ccc;
            border-color: #555;
        }

        /* Optional: light mode contrast improvement */
        body.light-mode .code-box {
            background-color: #f9f9f9;
            color: #333;
        }

        #feedback-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 500px;
            max-width: 90%;
            font-family: 'Segoe UI', sans-serif;
            max-height: 90vh;
            overflow-y: auto;
        }

        #feedback-modal h3 {
            margin: 0 0 10px 0;
        }

        #feedback-modal p {
            margin: 0 0 10px 0;
        }

        #feedback-modal ul {
            margin: 0 0 10px 0;
            padding-left: 20px;
        }

        #feedback-modal textarea {
            width: calc(100% - 20px);
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #bbb;
            margin-bottom: 10px;
            height: 100px;
        }

        #feedback-modal .modal-button-container {
            text-align: center;
            margin-top: 20px;
        }

        #feedback-modal .modal-button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #feedback-modal .submit-button {
            background-color: #4CAF50;
            color: white;
            margin-right: 10px;
        }

        #feedback-modal .submit-button:hover {
            background-color: #45a049;
        }

        #feedback-modal .cancel-button {
            background-color: #ccc;
            color: #333;
        }

        #feedback-modal .cancel-button:hover {
            background-color: #b0b0b0;
        }

        #success-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 500px;
            max-width: 90%;
            font-family: 'Segoe UI', sans-serif;
        }

        #success-modal h3 {
            margin: 0 0 10px 0;
        }

        #success-modal p {
            font-size: 16px;
            margin-top: 10px;
        }

        #save-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 400px;
            max-width: 90%;
            font-family: 'Segoe UI', sans-serif;
        }

        #save-modal h3 {
            margin: 0 0 10px 0;
        }

        #save-modal p {
            font-size: 16px;
        }

        #save-modal p:last-child {
            font-size: 14px;
            color: #666;
        }

        .position-feedback { /* New class for the feedback during stage 2 */
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .position-feedback h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 18px;
            color: #333;
        }

        .position-feedback textarea {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #bbb;
            margin-bottom: 10px;
            height: 100px;
        }

        .button-navigation {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

    </style>
</head>
<body>

<h2>Phase 2: Comprehensibility Ranking</h2>

<label for="participantName"><strong>Your Full Name:</strong></label>
<input type="text" id="participantName" placeholder="Enter your name"
       style="width: 300px; padding: 8px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ccc;"/>

<div class="instructions">
    <p><strong>Complete this on a PC, not a mobile phone.</strong></p>
    <p><strong>Instructions (Stage 1 - Ranking):</strong> Drag and drop the code snippets into the positions below,
        ranking them from easiest (left) to hardest (right).  You can place multiple snippets in the same
        position if you feel they have similar comprehensibility.  Click on a snippet to provide your
        reasoning for its comprehensibility.</p>
    <p><strong>Instructions (Stage 2 - Reasoning):</strong> After ranking, you will be prompted to provide
        explanations for your ranking.</p>
    <p><strong>Prohibited:</strong> Please <span style="color:red;">do not</span> use any automated metrics or
        generative AI tools (e.g., ChatGPT) for this task. We are seeking your expert judgment as a
        critical component of our research.</p>
</div>

<div id="stage1-ranking">
    <div style="display: flex; justify-content: space-between; margin: 10px 0 5px 0; padding: 0 5px;">
        <span style="font-weight: bold; color: #4CAF50;">⬅️ Easiest</span>
        <span style="font-weight: bold; color: #f44336;">Hardest ➡️</span>
    </div>
    <div id="positionsContainer">
        </div>

    <div class="snippet-header">
        Code Snippet Viewer
        <button id="code-theme-toggle" onclick="toggleCodeTheme()">Switch to Light Mode</button>
    </div>
    <div class="preview-area" id="previewArea"></div>
</div>

<div id="stage2-reasoning" style="display: none;">
    <div id="position-feedback-container">
        </div>
    <div class="button-navigation">
        <button id="prev-position" onclick="prevPosition()" style="display: none;">Previous</button>
        <button id="next-position" onclick="nextPosition()">Next</button>
    </div>
</div>


<button id="save-button" onclick="savePhase2State()">💾 Save Progress Locally</button>
<button id="review-button" onclick="reviewAndConfirmPhase2Submission()">Review and Submit</button>

<div id="feedback-modal" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">Review Your Submission</h3>
        <button onclick="hideModal()"
                style="background:none; border:none; font-size:20px; font-weight:bold; cursor:pointer; color:#333;">
            &times;
        </button>
    </div>

    <p><strong>Name:</strong> <span id="review-name"></span></p>

    <p><strong>Ranking (Easiest to Hardest):</strong></p>
    <ul id="review-ranking" style="margin-top:5px; padding-left:20px;"></ul>

    <p><strong>Reasoning:</strong></p>
    <div id="review-reasoning"
         style="white-space:pre-wrap; background:#f8f8f8; padding:10px; border:1px solid #ddd;
         border-radius:5px; margin-bottom:10px; max-height:250px; overflow-y:auto;">
    </div>

    <p id="review-error" style="color:rgb(255, 13, 0); font-weight:bold;">
    </p>

    <p id="review-warning" style="color: rgb(255, 140, 0); font-weight: bold;">
        ⚠️ Reminder: Please ensure you’ve provided reasoning for <u>each snippet</u> before submitting.
    </p>

    <div class="modal-button-container">
        <button class="modal-button submit-button" onclick="submitPhase2Final()">✅ Submit Now</button>
        <button class="modal-button cancel-button" onclick="hideModal()">Cancel</button>
    </div>
</div>

<div id="success-modal" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">Submission Successful</h3>
        <button onclick="document.getElementById('success-modal').style.display='none'"
                style="background:none; border:none; font-size:20px; font-weight:bold; cursor:pointer; color:#333;">
            &times;
        </button>
    </div>
    <p style="font-size:16px; margin-top:10px;">
        ✅ Submission successful! Thank you for your participation. We will contact you regarding the next steps.
    </p>
    <p>You may resubmit before the deadline if you change your mind about any part of your response.</p>
</div>

<div id="save-modal" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">Progress Saved</h3>
        <button onclick="hideSaveModal()"
                style="background:none; border:none; font-size:20px; font-weight:bold; cursor:pointer; color:#333;">&times;</button>
    </div>
    <p style="font-size:16px;">✅ Your progress has been saved locally in this browser.</p>
    <p style="font-size:14px; color:#666;">You can safely continue later or revise before submission.</p>
</div>

<script>
    function showSaveModal() {
        document.getElementById('save-modal').style.display = 'block';
    }

    function hideSaveModal() {
        document.getElementById('save-modal').style.display = 'none';
    }
</script>

<script>
    function showModal(message, isHTML = false) {
        const modal = document.getElementById('feedback-modal');
        const feedback = document.getElementById('review-name'); // Just to test modal is in review mode

        if (!modal || !feedback) {
            alert("Modal structure is missing from the HTML.");
            return;
        }

        if (!isHTML) {
            document.getElementById('review-error').innerText = message;
        }

        modal.style.display = 'block';
    }
</script>
<script>
    const snippets = [
        {
            id: 1,
            title: "Snippet 1",
            code: `<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">method1</span>(<span class="type">String</span> name) {
  <span class="keyword">if</span> (name == <span class="literal">null</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">if</span> (name.<span class="function">startsWith</span>(<span class="string">"."</span>)) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">if</span> ((name.<span class="function">length</span>() < <span class="number">1</span>) || (name.<span class="function">length</span>() > MAX_NAME_LENGTH)) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i < name.<span class="function">length</span>(); i++) {
    <span class="type">char</span> c = name.<span class="function">charAt</span>(i);
    <span class="keyword">if</span> (!Character.<span class="function">isLetterOrDigit</span>(c) && !VALID_NAME_SET.<span class="function">contains</span>(c)) {
      <span class="keyword">return</span> <span class="literal">false</span>;
    }
  }
  <span class="keyword">return</span> <span class="literal">true</span>;
}
`
        },
        {
            id: 2,
            title: "Snippet 2",
            code: `<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">method2</span>(<span class="type">URI</span> uri) {
  <span class="keyword">if</span> (<span class="function">isFilesystemPath</span>(uri)) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="type">String</span> scheme = uri.<span class="function">getScheme</span>();
  <span class="keyword">if</span> (scheme == <span class="literal">null</span>) {
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">switch</span> (scheme) {
    <span class="keyword">case</span> <span class="string">"file"</span>:
    <span class="keyword">case</span> <span class="string">"jar"</span>:
      <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">default</span>:
      <span class="keyword">break</span>;
  }
  <span class="keyword">return</span> <span class="literal">true</span>;
}
`
        },
        {
            id: 3,
            title: "Snippet 3",
            code: `<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">method3</span>(<span class="type">short</span> type) {
  <span class="keyword">if</span> (type == IMAGE_FILE_MACHINE_UNKNOWN) {
    <span class="comment">// Unsupported machine type</span>
    <span class="keyword">return</span> <span class="literal">false</span>;
  }
  <span class="keyword">for</span> (<span class="type">Field</span> field : CoffMachineType.<span class="function">class</span>.<span class="function">getDeclaredFields</span>()) {
    <span class="keyword">if</span> (!field.<span class="function">isSynthetic</span>()) {
      <span class="type">int</span> modifiers = field.<span class="function">getModifiers</span>();
      <span class="keyword">if</span> (<span class="function">Modifier.isFinal</span>(modifiers) && <span class="function">Modifier.isStatic</span>(modifiers)) {
        <span class="keyword">try</span> {
          <span class="keyword">if</span> (field.<span class="function">getShort</span>(<span class="literal">null</span>) == type) {
            <span class="keyword">return</span> <span class="literal">true</span>;
          }
        } <span class="keyword">catch</span> (<span class="type">IllegalAccessException</span> e) {
          <span class="keyword">continue</span>;
        }
      }
    }
  }
  <span class="keyword">return</span> <span class="literal">false</span>;
}
`
        },
        {
            id: 4,
            title: "Snippet 4",
            code: `<span class="keyword">public static</span> <span class="type">int</span> <span class="function">method4</span>(<span class="type">CharSequence</span> str, <span class="type">CharSequence</span> searchStr, <span class="type">int</span> startPos) {
  <span class="keyword">if</span> (str == <span class="literal">null</span> || searchStr == <span class="literal">null</span>) {
    <span class="keyword">return</span> INDEX_NOT_FOUND;
  }
  <span class="keyword">if</span> (startPos < <span class="number">0</span>) {
    startPos = <span class="number">0</span>;
  }
  <span class="type">int</span> searchStrLen = searchStr.<span class="function">length</span>();
  <span class="type">int</span> endLimit = str.<span class="function">length</span>() - searchStrLen + <span class="number">1</span>;
  <span class="keyword">if</span> (startPos > endLimit) {
    <span class="keyword">return</span> INDEX_NOT_FOUND;
  }
  <span class="keyword">if</span> (searchStrLen == <span class="number">0</span>) {
    <span class="keyword">return</span> startPos;
  }
  <span class="keyword">for</span> (<span class="type">int</span> i = startPos; i < endLimit...`
        },
        {
            id: 5,
            title: "Snippet 5",
            code: `<span class="keyword">public static</span> <span class="type">void</span> <span class="function">method5</span>() {
  <span class="type">Path</span> dir = <span class="function">createTempDir</span>();
  <span class="keyword">try</span> {
    <span class="type">Path</span> file = dir.<span class="function">resolve</span>(<span class="string">"foo.txt"</span>);
    <span class="function">createFile</span>(file);
    <span class="type">FileSystem</span> fs = <span class="function">createZip</span>(file);
    <span class="keyword">try</span> {
      <span class="type">Path</span> root = fs.<span class="function">getPath</span>(<span class="string">"/"</span>);
      <span class="function">createFile</span>(root.<span class="function">resolve</span>(<span class="string">"a.txt"</span>));
      <span class="function">createFile</span>(root.<span class="function">resolve</span>(<span class="string">"b.txt"</span>));
      <span class="type">Path</span> foo = root.<span class="function">resolve</span>(<span class="string">"c.txt"</span>);
      <span class="function">createFile</span>(foo);
      <span class="function">checkFoo</span>(foo);
    } <span class="keyword">finally</span> {
      fs.<span class="function">close</span>();
    }
  } <span class="keyword">catch</span> (<span class="type">IOException</span> e) {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>(e);
  }
}
`
        },
        {
            id: 6,
            title: "Snippet 6",
            code: `<span class="keyword">public static</span> <span class="type">int</span> <span class="function">method6</span>(<span class="type">int</span>[] arr, <span class="type">int</span> target) {
  <span class="keyword">if</span> (arr == <span class="literal">null</span> || arr.<span class="function">length</span>() == <span class="number">0</span>) {
    <span class="keyword">return</span> -<span class="number">1</span>;
  }
  <span class="type">int</span> low = <span class="number">0</span>;
  <span class="type">int</span> high = arr.<span class="function">length</span>() - <span class="number">1</span>;
  <span class="keyword">while</span> (low <= high) {
    <span class="type">int</span> mid = low + (high - low) / <span class="number">2</span>;
    <span class="keyword">if</span> (arr[mid] == target) {
      <span class="keyword">return</span> mid;
    } <span class="keyword">else</span> <span class="keyword">if</span> (arr[mid] < target) {
      low = mid + <span class="number">1</span>;
    } <span class="keyword">else</span> {
      high = mid - <span class="number">1</span>;
    }
  }
  <span class="keyword">return</span> -<span class="number">1</span>;
}
`
        },
        {
            id: 7,
            title: "Snippet 7",
            code: `<span class="keyword">public static</span> <span class="type">String</span> <span class="function">method7</span>(<span class="type">String</span> str) {
  <span class="keyword">if</span> (str == <span class="literal">null</span> || str.<span class="function">isEmpty</span>()) {
    <span class="keyword">return</span> <span class="string">""</span>;
  }
  <span class="type">String</span> result = <span class="string">""</span>;
  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i < str.<span class="function">length</span>(); i++) {
    <span class="type">char</span> c = str.<span class="function">charAt</span>(i);
    <span class="keyword">if</span> (Character.<span class="function">isUpperCase</span>(c)) {
      result += Character.<span class="function">toLowerCase</span>(c);
    } <span class="keyword">else</span> {
      result += c;
    }
  }
  <span class="keyword">return</span> result;
}
`
        },
        {
            id: 8,
            title: "Snippet 8",
            code: `<span class="keyword">public static</span> <span class="type">List</span><<span class="type">Integer</span>> <span class="function">method8</span>(<span class="type">List</span><<span class="type">Integer</span>> list) {
  <span class="keyword">if</span> (list == <span class="literal">null</span> || list.<span class="function">isEmpty</span>()) {
    <span class="keyword">return</span> Collections.<span class="function">emptyList</span>();
  }
  <span class="type">List</span><<span class="type">Integer</span>> result = <span class="keyword">new</span> <span class="type">ArrayList</span><>();
  <span class="keyword">for</span> (<span class="type">Integer</span> num : list) {
    <span class="keyword">if</span> (num % <span class="number">2</span> == <span class="number">0</span>) {
      result.<span class="function">add</span>(num);
    }
  }
  <span class="keyword">return</span> result;
}
`
        }
    ];

    const NUM_POSITIONS = 8;
    let currentStage = 1;
    let positions = [];
    let snippetReasonings = {};  // Store snippet-specific reasonings,
    let positionReasonings = {}; // Store combined position reasonings (stage 2)
    let currentPosition = 0;

    function initializePositions() {
        positions = [];
        for (let i = 0; i < NUM_POSITIONS; i++) {
            positions.push({ position: i + 1, snippets: [] });
        }
    }

    function createPositionElements() {
        const positionsContainer = document.getElementById('positionsContainer');
        positionsContainer.innerHTML = ''; // Clear existing positions

        for (let i = 0; i < NUM_POSITIONS; i++) {
            const positionDiv = document.createElement('div');
            positionDiv.classList.add('rank-section');
            positionDiv.dataset.position = i + 1;

            const titleDiv = document.createElement('div');
            titleDiv.classList.add('position-title');
            titleDiv.textContent = `Position ${i + 1}:`;
            positionDiv.appendChild(titleDiv);

            const cardsDiv = document.createElement('div');
            cardsDiv.classList.add('cards-container');
            cardsDiv.id = `position-${i + 1}`;
            positionDiv.appendChild(cardsDiv);

            positionsContainer.appendChild(positionDiv);
        }
        loadInitial ترتيب(); //important
    }

    function displaySnippets() {
        if (currentStage === 1) {
            const positionsContainer = document.getElementById('positionsContainer');
            if (!positionsContainer) {
                console.error('positionsContainer is null');
                return;
            }

            positionsContainer.innerHTML = ''; // Clear the container
            for (let i = 0; i < NUM_POSITIONS; i++) {
                const positionDiv = document.createElement('div');
                positionDiv.classList.add('rank-section');
                positionDiv.dataset.position = i + 1;

                const titleDiv = document.createElement('div');
                titleDiv.classList.add('position-title');
                titleDiv.textContent = `Position ${i + 1}:`;
                positionDiv.appendChild(titleDiv);

                const cardsDiv = document.createElement('div');
                cardsDiv.classList.add('cards-container');
                cardsDiv.id = `position-${i + 1}`;
                positionDiv.appendChild(cardsDiv);
                positionsContainer.appendChild(positionDiv);

            }

            // Add snippets to their positions
            positions.forEach(position => {
                const positionDiv = document.getElementById(`position-${position.position}`);
                if (!positionDiv) {
                    console.warn(`Position div not found: position-${position.position}`);
                    return; // Skip if the position div doesn't exist
                }
                position.snippets.forEach(snippetId => {
                    const snippet = snippets.find(s => s.id === snippetId);
                    if (snippet) {
                        const card = document.createElement('div');
                        card.classList.add('card');
                        card.dataset.snippetId = snippet.id;
                        card.textContent = snippet.title;
                        card.draggable = true;
                        card.addEventListener('dragstart', handleDragStart);
                        card.addEventListener('click', () => showSnippetReasoningInput(snippet.id)); // Show textarea
                        positionDiv.appendChild(card);
                    }
                });
            });
        } else if (currentStage === 2) {
            // Stage 2: Display feedback inputs
            const feedbackContainer = document.getElementById('position-feedback-container');
            feedbackContainer.innerHTML = ''; // Clear previous content.
            for (let i = 0; i < NUM_POSITIONS; i++)
            {
              if(positions[i].snippets.length>0){
                const positionFeedbackDiv = document.createElement('div');
                positionFeedbackDiv.classList.add('position-feedback');
                positionFeedbackDiv.dataset.position = i + 1;

                const header = document.createElement('h4');
                header.textContent = `Reasoning for Position ${i + 1}`;
                positionFeedbackDiv.appendChild(header);

                if (positions[i].snippets.length > 1) {
                    const sameReasoningLabel = document.createElement('label');
                    sameReasoningLabel.textContent="Explain why you grouped these snippets together:";
                    const sameReasoningInput = document.createElement('textarea');
                    sameReasoningInput.id = `same-reasoning-${i + 1}`;
                    positionFeedbackDiv.appendChild(sameReasoningLabel);
                    positionFeedbackDiv.appendChild(sameReasoningInput);
                }
                if(i<NUM_POSITIONS-1) {
                  const comparisonReasoningLabel = document.createElement('label');
                  comparisonReasoningLabel.textContent = `Explain why snippets in Position ${i + 1} are more comprehensible than those in Position ${i + 2}:`;
                  const comparisonReasoningInput = document.createElement('textarea');
                  comparisonReasoningInput.id = `comparison-reasoning-${i + 1}-${i + 2}`;
                  positionFeedbackDiv.appendChild(comparisonReasoningLabel);
                  positionFeedbackDiv.appendChild(comparisonReasoningInput);
                }
                feedbackContainer.appendChild(positionFeedbackDiv);
              }
            }
            displayCurrentPositionFeedback();
        }
    }

    function handleDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.dataset.snippetId);
        event.target.classList.add('dragging');
    }

    function handleDragOver(event) {
        event.preventDefault();
    }

    function handleDrop(event) {
        event.preventDefault();
        const snippetId = event.dataTransfer.getData('text/plain');
        const targetPosition = parseInt(event.currentTarget.parentElement.dataset.position); //gets the position контейнера а не card
        const droppedSnippet = document.querySelector(`.card[data-snippet-id="${snippetId}"]`);

        if (!droppedSnippet) {
            console.error('Dropped snippet not found');
            return;
        }
        // Remove snippet from its old position
        positions.forEach(pos => {
            pos.snippets = pos.snippets.filter(id => id !== parseInt(snippetId));
        });

        // Add snippet to the new position
        const targetPositionObj = positions.find(pos => pos.position === targetPosition);
        if (targetPositionObj) {
            targetPositionObj.snippets.push(parseInt(snippetId));
        }
        else{
          console.error("Target position object does not exist");
        }
        event.currentTarget.appendChild(droppedSnippet); // Append to the target position's container
        droppedSnippet.classList.remove('dragging');
        saveCurrentRanking(); // Save the state whenever a drop occurs
        displaySnippets();
    }

    function showSnippetReasoningInput(snippetId) {
        const snippet = snippets.find(s => s.id === snippetId);
        if (snippet) {
            const existingTextarea = document.getElementById(`reasoning-for-${snippetId}`);
            if (existingTextarea)
            {
              document.getElementById('previewArea').removeChild(existingTextarea);
            }
            const textarea = document.createElement('textarea');
            textarea.id = `reasoning-for-${snippetId}`;
            textarea.placeholder = `Enter your reasoning for ${snippet.title}...`;
            textarea.value = snippetReasonings[snippetId] || ''; // Load saved reasoning
            textarea.addEventListener('blur', () => {
                snippetReasonings[snippetId] = textarea.value;
                saveCurrentReasoning();
            });
            document.getElementById('previewArea').appendChild(textarea);
        }
    }

    function saveCurrentReasoning() {
        sessionStorage.setItem('snippetReasonings', JSON.stringify(snippetReasonings));
        document.cookie = `snippetReasonings=${encodeURIComponent(JSON.stringify(snippetReasonings))}; path=/; max-age=31536000`; // 1 year
    }

      function loadSavedReasoning() {
        const sessionReasoning = sessionStorage.getItem('snippetReasonings');
        const cookieReasoning = getCookie('snippetReasonings');

        if (sessionReasoning) {
            snippetReasonings = JSON.parse(sessionReasoning);
        } else if (cookieReasoning) {
            try {
                snippetReasonings = JSON.parse(decodeURIComponent(cookieReasoning));
            } catch (error) {
                console.error('Error parsing cookieReasoning:', error);
                snippetReasonings = {};
            }
        } else {
          snippetReasonings = {};
        }
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function saveCurrentRanking() {
        const ranking = positions.map(pos => ({
            position: pos.position,
            snippets: pos.snippets
        }));
        sessionStorage.setItem('phase2Ranking', JSON.stringify(ranking));
        document.cookie = `phase2Ranking=${encodeURIComponent(JSON.stringify(ranking))}; path=/; max-age=31536000`; // 1 year
    }

  function loadInitialRanking() {
    const sessionRankingData = sessionStorage.getItem('phase2Ranking');
    const cookieRankingData = getCookie('phase2Ranking');

    if (sessionRankingData) {
      try {
        positions = JSON.parse(sessionRankingData);
      } catch (e) {
        console.error("Error parsing session ranking data", e);
        initializePositions();
      }
    } else if (cookieRankingData) {
      try {
        positions = JSON.parse(decodeURIComponent(cookieRankingData));
      } catch (e) {
        console.error("Error parsing cookie ranking data", e);
        initializePositions();
      }
    } else {
      initializePositions();
    }
  }

  function loadInitial ترتيب()
  {
    if (positions.length == 0)
    {
      initializePositions();
    }
    if (positions[0].snippets.length == 0)
    {
       // Distribute snippets to initial positions (assuming even distribution for simplicity)
        const numSnippets = snippets.length;
        const snippetsPerPosition = Math.ceil(numSnippets / NUM_POSITIONS);

        snippets.forEach((snippet, index) => {
            const positionIndex = Math.floor(index / snippetsPerPosition);
            positions[positionIndex].snippets.push(snippet.id);
        });
    }
  }

    function savePhase2State() {
        saveCurrentRanking();
        saveCurrentReasoning();
        showSaveModal();
    }

    function loadPhase2State() {
        loadInitialRanking();
        loadSavedReasoning();
        const savedStage = sessionStorage.getItem('phase2Stage');
        if (savedStage) {
            currentStage = parseInt(savedStage);
        }
    }



    function reviewAndConfirmPhase2Submission() {
        const participantName = document.getElementById('participantName').value.trim();
        if (!participantName) {
            showModal('Please enter your full name.');
            return;
        }

        if (Object.keys(snippetReasonings).length < snippets.length) {
            showModal('Please provide reasoning for every snippet.');
            return;
        }
        //check that stage 2 is done
        if (currentStage < 2)
        {
          showModal('Please complete all stages before review.');
          return;
        }

        const modal = document.getElementById('feedback-modal');
        const reviewName = document.getElementById('review-name');
        const reviewRanking = document.getElementById('review-ranking');
        const reviewReasoning = document.getElementById('review-reasoning');
        const reviewError = document.getElementById('review-error');
        const reviewWarning = document.getElementById('review-warning');


        reviewName.textContent = participantName;
        reviewRanking.innerHTML = ''; // Clear previous review ranking
        let rankingText = "";
        positions.forEach((pos, index) => {
            const li = document.createElement('li');
            const snippetTitles = pos.snippets.map(id => {
                const snip = snippets.find(s => s.id === id);
                return snip ? snip.title : `Snippet ${id}`;
            }).join(', ');
            li.textContent = `Position ${index + 1}: ${snippetTitles}`;
            reviewRanking.appendChild(li);
            rankingText += `Position ${index+1}: ${snippetTitles} | `;
        });
        sessionStorage.setItem('finalRanking', rankingText);

        let reasoningText = "";
        reviewReasoning.innerHTML = ''; // Clear previous review reasoning
        for (const [snippetId, reasoning] of Object.entries(snippetReasonings)) {
            const snippet = snippets.find(s => s.id === parseInt(snippetId));
            if (snippet) {
                const p = document.createElement('p');
                p.innerHTML = `<strong>${snippet.title}:</strong> ${reasoning}`;
                reviewReasoning.appendChild(p);
                reasoningText += `${snippet.title}: ${reasoning}  `;
            }
        }
        sessionStorage.setItem('finalReasoning', reasoningText);
        sessionStorage.setItem('participantName', participantName);
        modal.style.display = 'block';
        reviewError.innerText = ''; // Clear any previous error message
        reviewWarning.style.display = 'none';
    }

    function hideModal() {
        document.getElementById('feedback-modal').style.display = 'none';
    }

    function submitPhase2Final() {
        const participantName = document.getElementById('participantName').value.trim();

        if (!participantName) {
            showModal('Please enter your full name.');
            return;
        }

        if (Object.keys(snippetReasonings).length < snippets.length) {
            showModal('Please provide reasoning for every snippet.');
            return;
        }
         if (currentStage < 2)
        {
          showModal('Please complete all stages before submit.');
          return;
        }

        // Stage 2: Validate that all position reasonings are provided
        let allPositionReasoningsProvided = true;
        for (let i = 0; i < NUM_POSITIONS; i++) {
            if (positions[i].snippets.length > 1 && !document.getElementById(`same-reasoning-${i + 1}`).value.trim()) {
                allPositionReasoningsProvided = false;
                break;
            }
            if (i < NUM_POSITIONS -1 && positions[i].snippets.length > 0 && positions[i+1].snippets.length>0 && !document.getElementById(`comparison-reasoning-${i + 1}-${i + 2}`).value.trim()) {
                allPositionReasoningsProvided = false;
                break;
            }
        }

        if (!allPositionReasoningsProvided) {
            showModal('Please answer all questions in Stage 2.');
            return;
        }

        // Collect all data for submission
        const submissionData = {
            participantName: participantName,
            ranking: positions.map(pos => ({
                position: pos.position,
                snippets: pos.snippets,
                reason: pos.position > 1 ? document.getElementById(`comparison-reasoning-${pos.position-1}-${pos.position}`)?.value : null,
                sameReason: pos.snippets.length > 1 ? document.getElementById(`same-reasoning-${pos.position}`)?.value: null
            })),
            snippetReasonings: snippetReasonings,
        };

        // Convert data to JSON string for storage or submission
        const submissionJson = JSON.stringify(submissionData);
        console.log("Final Submission Data:", submissionJson);  //  for debugging

        // Clear local storage and cookies
        sessionStorage.removeItem('phase2Ranking');
        sessionStorage.removeItem('snippetReasonings');
        sessionStorage.removeItem('phase2Stage');
        sessionStorage.removeItem('finalRanking');
        sessionStorage.removeItem('finalReasoning');
        sessionStorage.removeItem('participantName');
        document.cookie = 'phase2Ranking=; path=/; max-age=0';
        document.cookie = 'snippetReasonings=; path=/; max-age=0';
        document.cookie = 'phase2Stage=; path=/; max-age=0';
        document.cookie = 'finalRanking=; path=/; max-age=0';
        document.cookie = 'finalReasoning=; path=/; max-age=0';
        document.cookie = 'participantName=; path=/; max-age=0';

        document.getElementById('feedback-modal').style.display = 'none'; // Hide modal
        document.getElementById('success-modal').style.display = 'block'; // Show success message
        // You would typically send this data to your server here using fetch or similar
        // Example (replace with your actual server endpoint):
        /*
        fetch('/api/submit-phase2', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: submissionJson
        })
        .then(response => {
            if (response.ok) {
                // Handle success (e.g., show a thank you message)
                document.getElementById('success-modal').style.display = 'block';
            } else {
                // Handle error (e.g., show an error message)
                showModal('Submission failed. Please try again.');
            }
        })
        .catch(error => {
            // Handle network error
            showModal('Network error. Please check your connection and try again.');
        });
        */
    }



    function toggleCodeTheme() {
        const body = document.body;
        const button = document.getElementById('code-theme-toggle');
        const isLight = body.classList.contains('code-light');

        if (isLight) {
            body.classList.remove('code-light');
            body.classList.add('code-dark');
            localStorage.setItem('codeTheme', 'dark');
            button.textContent = 'Switch to Light Mode';
        } else {
            body.classList.remove('code-dark');
            body.classList.add('code-light');
            localStorage.setItem('codeTheme', 'light');
            button.textContent = 'Switch to Dark Mode';
        }
    }

    // Load saved code theme preference on page load
    window.addEventListener('DOMContentLoaded', () => {
        const theme = localStorage.getItem('codeTheme') || 'dark';
        document.body.classList.add(`code-${theme}`);
        document.getElementById('code-theme-toggle').textContent = theme === 'light'
            ? 'Switch to Dark Mode'
            : 'Switch to Light Mode';
        loadPhase2State(); // Load saved state
        if (currentStage === 1) {
          createPositionElements();
          displaySnippets();
        }
        else if (currentStage === 2)
        {
          document.getElementById("stage1-ranking").style.display = "none";
          document.getElementById("stage2-reasoning").style.display = "block";
          displaySnippets();
          displayCurrentPositionFeedback();
        }


    });

    // Stage 2 functions
    function startStage2() {
        currentStage = 2;
        sessionStorage.setItem('phase2Stage', currentStage); //save stage
        document.getElementById('stage1-ranking').style.display = 'none';
        document.getElementById('stage2-reasoning').style.display = 'block';
        displaySnippets(); // Generate stage 2 content
        document.getElementById('save-button').style.display = 'none';
        document.getElementById('review-button').style.display = 'none';
    }


  function displayCurrentPositionFeedback() {
    const feedbackContainer = document.getElementById('position-feedback-container');
    const positionsElements = feedbackContainer.querySelectorAll('.position-feedback');

    positionsElements.forEach((element, index) => {
        if (index === currentPosition) {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    });

    // Update button states
    const prevButton = document.getElementById('prev-position');
    const nextButton = document.getElementById('next-position');

    prevButton.style.display = currentPosition > 0 ? 'inline-block' : 'none';
    nextButton.textContent = currentPosition < NUM_POSITIONS - 1 ? 'Next' : 'Finish';
}

    function nextPosition() {
      if (currentPosition < NUM_POSITIONS - 1) {
          currentPosition++;
          displayCurrentPositionFeedback();
      } else {
          // Finish Stage 2 - save data and go to review
          saveStage2Reasonings(); // Save stage 2 data
          reviewAndConfirmPhase2Submission(); //call review
      }
    }

    function prevPosition() {
        if (currentPosition > 0) {
            currentPosition--;
            displayCurrentPositionFeedback();
        }
    }

    function saveStage2Reasonings() {
        const numPositions = positions.length;
        for (let i = 0; i < numPositions; i++) {
          if (positions[i].snippets.length > 1)
          {
            const sameReasoningInput = document.getElementById(`same-reasoning-${i + 1}`);
            if (sameReasoningInput) {
                positionReasonings[`same-${i + 1}`] = sameReasoningInput.value;
            }
          }
          if (i < numPositions - 1)
          {
            const comparisonReasoningInput = document.getElementById(`comparison-reasoning-${i + 1}-${i+2}`);
              if (comparisonReasoningInput) {
                  positionReasonings[`comparison-${i + 1}-${i+2}`] = comparisonReasoningInput.value;
              }
          }
        }
        sessionStorage.setItem('positionReasonings', JSON.stringify(positionReasonings));
        document.cookie = `positionReasonings=${encodeURIComponent(JSON.stringify(positionReasonings))}; path=/; max-age=31536000`;
    }

  function loadStage2Reasonings() {
      const storedPositionReasonings = sessionStorage.getItem('positionReasonings');
      const cookiePositionReasonings = getCookie('positionReasonings');

      if (storedPositionReasonings) {
          positionReasonings = JSON.parse(storedPositionReasonings);
      } else if (cookiePositionReasonings) {
        try{
          positionReasonings = JSON.parse(decodeURIComponent(cookiePositionReasonings));
        }
        catch(error)
        {
          console.error("Error parsing position reasonings",error);
          positionReasonings = {};
        }
      }
      else {
          positionReasonings = {};
      }
  }

  // Event listener for starting stage 2
  document.getElementById('review-button').addEventListener('click', () => {
    if (Object.keys(snippetReasonings).length < snippets.length)
    {
       showModal('Please provide reasoning for every snippet.');
       return;
    }
    if (currentStage === 1) {
      startStage2();
    }
  });

  loadPhase2State(); //on load
  loadStage2Reasonings();
  if (currentStage === 1) {
    createPositionElements();
    displaySnippets();
  }
  else if (currentStage === 2)
  {
    document.getElementById("stage1-ranking").style.display = "none";
    document.getElementById("stage2-reasoning").style.display = "block";
    displaySnippets();
    displayCurrentPositionFeedback();
  }

</script>

<footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 14px; color: #666;">
    <div>
        Please contact us if you have any questions or issues: <a href="mailto:ea496@columbia.edu">ea496@columbia.edu</a>
    </div>
</footer>
</body>
</html>
