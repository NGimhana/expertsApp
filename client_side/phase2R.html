<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phase 2: Individual Snippet Reasoning</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background-color: #f9f9f9;
    }
    .code-light {
      background-color: #f9f9f9;
      color: #333;
    }
    .code-dark {
      background-color: #2d2d2d;
      color: #ccc;
    }
    .snippet-box {
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      margin-bottom: 20px;
    }
    .navigation-buttons button, #continue-button, #theme-toggle {
      padding: 10px 20px;
      margin: 10px 10px 10px 0;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .navigation-buttons button {
      background-color: #4CAF50;
      color: white;
    }
    #continue-button {
      background-color: #2196F3;
      color: white;
      display: none;
    }
    #theme-toggle {
      background-color: #333;
      color: white;
    }
    #theme-toggle:hover {
      background-color: #555;
    }
    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #bbb;
    }
    label {
      font-weight: bold;
    }
    .instructions {
      margin-bottom: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #continue-button:hover, button[onclick*='phase1'] {
    background-color: #45a049;
  }

  @keyframes glowPulse {
    0% {
      box-shadow: 0 0 10px #4CAF50;
    }
    100% {
      box-shadow: 0 0 20px #4CAF50, 0 0 30px #4CAF50;
    }
  }

  button[disabled] {
    background-color: #888;
    cursor: not-allowed;
  }
</style>
</head>
<body>
  <h2>Phase 2: Individual Snippet Reasoning</h2>

  <button id="theme-toggle" onclick="toggleTheme()">Switch to Dark Mode</button>

  <label for="participantName">Your Full Name:</label>
  <input type="text" id="participantName" style="width: 300px; padding: 8px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ccc;" />

  <div class="instructions">
    <p><strong>Instructions:</strong> In this phase, you will view one code snippet at a time. For each snippet, please assess its comprehensibility by describing what makes it easy or hard to understand. Consider aspects like naming, logic clarity, code structure, and use of language constructs. Your responses are saved automatically as you go.</p>
  </div>

  <div id="snippet-container">
    <div style="background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #ccc;">
        <h3 id="snippetTitle" style="margin: 0;">Snippet Title</h3>
        <button onclick="toggleTheme()" id="theme-toggle" style="padding: 6px 12px; border-radius: 5px; border: none; background-color: #333; color: white; cursor: pointer;">
          Switch to Light Mode
        </button>
      </div>
      <pre id="snippetBox" class="snippet-box code-dark" style="margin: 0;"><code>Loading snippet...</code></pre>
    </div>
  </div>

  <label for="reasoningBox">Tell us about how do you assess this snippet's comprehensibility? What features might make it easy to understand? What features make it hard to understand?</label>
  <textarea id="reasoningBox" placeholder="Write your explanation here..."></textarea>

  <div class="navigation-buttons">
    <button onclick="prevSnippet()">⬅️ Previous</button>
    <button onclick="nextSnippet()" id="nextButton">Next ➡️</button>
  </div>

  <button onclick="location.href='/phase1.html'" style="
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
  ">⬅️ Back to Phase 1</button>

<button id="continue-button" onclick="goToPhase3()" style="
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 0 10px #4CAF50;
    animation: glowPulse 1.5s infinite alternate;
  ">Continue to Phase 3</button>

  <div id="validation-modal" style="
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff0f0;
    color: #660000;
    border: 1px solid #ff9999;
    padding: 20px;
    border-radius: 10px;
    width: 440px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 1002;
    text-align: center;
    font-family: 'Segoe UI', Tahoma, sans-serif;
  ">
    <p id="validation-message" style="font-weight: bold;"></p>
    <button onclick="document.getElementById('validation-modal').style.display = 'none';" style="
      margin-top: 15px;
      padding: 8px 14px;
      background-color: #ff9999;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    ">OK</button>
  </div>

  <script>
    const snippets = [
      {
        id: 1,
        title: "Snippet 1",
        code: `public static boolean method1(String name) {\n  if (name == null || name.startsWith(".")) return false;\n  if (name.length() < 1 || name.length() > MAX_NAME_LENGTH) return false;\n  for (int i = 0; i < name.length(); i++) {\n    char c = name.charAt(i);\n    if (!Character.isLetterOrDigit(c) && !VALID_NAME_SET.contains(c)) return false;\n  }\n  return true;\n}`
      },
      {
        id: 2,
        title: "Snippet 2",
        code: `public static boolean method2(URI uri) {\n  if (isFilesystemPath(uri)) return false;\n  String scheme = uri.getScheme();\n  if (scheme == null) return false;\n  switch (scheme) {\n    case "file": case "jar": return false;\n    default: break;\n  }\n  return true;\n}`
      }
    ];

    let currentIndex = 0;
    const reasoningPerSnippet = {};

    window.onload = function() {
      const nameFromCombined = sessionStorage.getItem('participantName') || decodeURIComponent(getCookie('participantName') || '');
      const saved = JSON.parse(sessionStorage.getItem('phase2_state') || '{}');
      if (saved.name) {
        document.getElementById('participantName').value = saved.name;
      } else if (nameFromCombined) {
        document.getElementById('participantName').value = nameFromCombined;
      }
      if (saved.reasoningMap) Object.assign(reasoningPerSnippet, saved.reasoningMap);
      loadSnippet(currentIndex);
      applySavedTheme();
    };

    function loadSnippet(index) {
      const snippet = snippets[index];
      document.getElementById('snippetTitle').innerText = snippet.title;
      document.getElementById('snippetBox').innerHTML = snippet.code;
      document.getElementById('reasoningBox').value = reasoningPerSnippet[snippet.id] || '';
      checkNextButton();
    }

    function saveState() {
      const name = document.getElementById('participantName').value.trim();
      const reasoning = document.getElementById('reasoningBox').value.trim();
      reasoningPerSnippet[snippets[currentIndex].id] = reasoning;
      const data = { name, reasoningMap: reasoningPerSnippet };
      sessionStorage.setItem('phase2_state', JSON.stringify(data));
      document.cookie = `phase2_state=${encodeURIComponent(JSON.stringify(data))}; path=/; max-age=${60*60*24*30}`;
      checkNextButton();
    }

    function prevSnippet() {
      saveState();
      if (currentIndex > 0) {
        currentIndex--;
        loadSnippet(currentIndex);
      }
    }

    function nextSnippet() {
      if (document.getElementById('reasoningBox').value.trim() === '') {
        showValidation("Please provide your reasoning before moving to the next snippet.");
        return;
      }
      saveState();
      if (currentIndex < snippets.length - 1) {
        currentIndex++;
        loadSnippet(currentIndex);
      }
    }

    function showValidation(message) {
      document.getElementById('validation-message').innerText = message;
      document.getElementById('validation-modal').style.display = 'block';
    }

    function goToPhase3() {
      saveState();
      location.href = '/phase3.html';
    }

    function toggleTheme() {
      const box = document.getElementById('snippetBox');
      const toggleBtn = document.getElementById('theme-toggle');
      const isDark = box.classList.contains('code-dark');
      box.classList.remove(isDark ? 'code-dark' : 'code-light');
      box.classList.add(isDark ? 'code-light' : 'code-dark');
      toggleBtn.textContent = isDark ? 'Switch to Dark Mode' : 'Switch to Light Mode';
      localStorage.setItem('codeBoxTheme', isDark ? 'light' : 'dark');
    }

    function applySavedTheme() {
      const theme = localStorage.getItem('codeBoxTheme') || 'dark';
      document.getElementById('snippetBox').classList.add(`code-${theme}`);
      document.getElementById('theme-toggle').textContent = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? decodeURIComponent(match[2]) : null;
    }

    function checkNextButton() {
      document.getElementById('nextButton').disabled = document.getElementById('reasoningBox').value.trim() === '';
      const allFilled = snippets.every(snippet => reasoningPerSnippet[snippet.id] && reasoningPerSnippet[snippet.id].trim() !== '');
      document.getElementById('continue-button').style.display = allFilled ? 'inline-block' : 'none';
    }

    document.getElementById('reasoningBox').addEventListener('input', saveState);
    document.getElementById('participantName').addEventListener('input', saveState);
  </script>
</body>
</html>
