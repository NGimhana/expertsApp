<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Final Review</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
      color: #333;
    }
    h2 {
      margin-bottom: 10px;
    }
    .section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    pre, .code-box {
      background: #2d2d2d;
      color: #ccc;
      padding: 10px;
      border-radius: 5px;
      font-family: 'Courier New', Courier, monospace;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    button {
      padding: 10px 20px;
      margin: 10px 10px 0 0;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .nav-button {
      background-color: #777;
      color: white;
    }
    .submit-button {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Final Review</h1>

  <div class="section">
    <h2>Phase 1: Summary and Comprehensibility</h2>
    <div id="phase1"></div>
    <button class="nav-button" onclick="location.href='/phase1.html'">Update Phase 1</button>
  </div>

  <div class="section">
    <h2>Phase 2: Per-Snippet Reasoning</h2>
    <div id="phase2"></div>
    <button class="nav-button" onclick="location.href='/phase2.html'">Update Phase 2</button>
  </div>

  <div class="section">
    <h2>Phase 3: Snippet Ranking</h2>
    <div id="phase3"></div>
    <button class="nav-button" onclick="location.href='/phase3.html'">Update Phase 3</button>
  </div>

  <div class="section">
    <h2>Phase 4: Ranking Reasoning</h2>
    <div id="phase4"></div>
    <button class="nav-button" onclick="location.href='/phase4.html'">Update Phase 4</button>
  </div>

  <button class="submit-button" onclick="submitAll()">✅ Submit All Responses</button>

  <script>
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? decodeURIComponent(match[2]) : null;
    }

    function renderPhase1() {
      const data = JSON.parse(sessionStorage.getItem('phase1_state') || getCookie('phase1_state') || '{}');
      const container = document.getElementById('phase1');
      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<em>No data found.</em>';
        return;
      }
      Object.entries(data).forEach(([id, content]) => {
        container.innerHTML += `<p><strong>Snippet ${id}:</strong><br><em>Summary:</em> ${content.summary}<br><em>Comprehensibility:</em> ${content.comprehensibility}</p>`;
      });
    }

    function renderPhase2() {
      const data = JSON.parse(sessionStorage.getItem('phase2_state') || getCookie('phase2_state') || '{}');
      const container = document.getElementById('phase2');
      if (!data || !data.reasoningMap) {
        container.innerHTML = '<em>No data found.</em>';
        return;
      }
      Object.entries(data.reasoningMap).forEach(([id, reason]) => {
        container.innerHTML += `<p><strong>Snippet ${id}:</strong><br>${reason}</p>`;
      });
    }

    function renderPhase3() {
      const data = JSON.parse(sessionStorage.getItem('phase3_ranking') || getCookie('phase3_ranking') || '{}');
      const container = document.getElementById('phase3');
      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<em>No data found.</em>';
        return;
      }
      Object.entries(data).forEach(([rank, ids]) => {
        container.innerHTML += `<p><strong>Position ${rank}:</strong> ${ids.map(id => id.replace('snippet-', '')).join(', ')}</p>`;
      });
    }

    function renderPhase4() {
      const data = JSON.parse(sessionStorage.getItem('phase3_reasoning') || '{}');
      const container = document.getElementById('phase4');
      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<em>No data found.</em>';
        return;
      }
      Object.entries(data).forEach(([key, answer], i) => {
        container.innerHTML += `<p><strong>Q${i + 1}:</strong> ${answer}</p>`;
      });
    }

    function submitAll() {
      const p1 = JSON.parse(sessionStorage.getItem('phase1_state') || '{}');
      const p2 = JSON.parse(sessionStorage.getItem('phase2_state') || '{}');
      const p3 = JSON.parse(sessionStorage.getItem('phase3_ranking') || '{}');
      const p4 = JSON.parse(sessionStorage.getItem('phase3_reasoning') || '{}');
      const payload = { phase1: p1, phase2: p2, phase3: p3, phase4: p4 };
      fetch('https://codecomprehensibility.site/submit_final', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(res => res.ok ? alert('✅ Submission successful!') : alert('❌ Submission failed.'))
        .catch(() => alert('⚠️ Error during submission.'));
    }

    renderPhase1();
    renderPhase2();
    renderPhase3();
    renderPhase4();
  </script>
</body>
</html>