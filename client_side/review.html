<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Final Review</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0 40px 40px 40px; /* top right bottom left */
      background-color: #f4f4f4;
      color: #333;
    }
    h2 {
      margin-bottom: 10px;
    }
    .section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    pre, .code-box {
      background: #2d2d2d;
      color: #ccc;
      padding: 10px;
      border-radius: 5px;
      font-family: 'Courier New', Courier, monospace;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    button {
      padding: 10px 20px;
      margin: 10px 10px 0 0;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .nav-button {
      background-color: #777;
      color: white;
    }
    .submit-button {
      background-color: #4CAF50;
      color: white;
    }

    /*status bar*/
    .status-bar {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: center;
      gap: 30px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .phase-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .phase-link:hover:not(.disabled) {
      background-color: #4CAF50;
    }

    .phase-link.active {
      background-color: #4CAF50;
    }

    .phase-link.disabled {
      pointer-events: none;
      opacity: 0.5;
      cursor: not-allowed;
    }

  </style>
</head>
<body>

  <div class="status-bar">
    <div id="user-info" style="padding: 8px 12px; color: gainsboro; font-weight: bold;"></div>
    <a href="index.html" class="phase-link" id="link-home">üè† Home</a>
    <a href="phase1.html" class="phase-link" id="link-phase1">Phase 1</a>
    <a href="phase2.html" class="phase-link" id="link-phase2">Phase 2</a>
    <a href="phase3.html" class="phase-link" id="link-phase3">Phase 3</a>
    <a href="review.html" class="phase-link active" id="link-review">Review & Submit</a>
  </div>

  
  <h1>Final Review</h1>

  <div class="section">
    <h2>Phase 1: Summary and Comprehensibility</h2>
    <div id="phase1"></div>
    <button class="nav-button" onclick="location.href='/phase1.html'">Update Phase 1</button>
  </div>  

  <div class="section">
    <h2>Phase 2: Snippet Ranking</h2>
    <div id="phase2"></div>
    <button class="nav-button" onclick="location.href='/phase2.html'">Update Phase 2</button>
  </div>

  <div class="section">
    <h2>Phase 3: Ranking Reasoning</h2>
    <div id="phase3"></div>
    <button class="nav-button" onclick="location.href='/phase3.html'">Update Phase 3</button>
  </div>

  <button class="submit-button" onclick="submitAll()">‚úÖ Submit All Responses</button>

  <script>
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? decodeURIComponent(match[2]) : null;
    }

    function renderPhase1() {
      const container = document.getElementById('phase1');
      let foundAny = false;

      for (let i = 1; i <= 8; i++) {
        const summaryKey = `summary${i}`;
        const compKey = `compSummary${i}`;

        const summary = sessionStorage.getItem(summaryKey) || decodeURIComponent(getCookie(summaryKey) || '');
        const comp = sessionStorage.getItem(compKey) || decodeURIComponent(getCookie(compKey) || '');

        if (summary || comp) {
          foundAny = true;
          container.innerHTML += `
            <div style="margin-bottom: 15px;">
              <strong>Snippet ${i}</strong><br>
              <strong>Summary:</strong> ${summary || '<em>No summary</em>'}<br>
              <strong>Comprehensibility:</strong> ${comp || '<em>No explanation</em>'}
            </div>
          `;
        }
      }

      if (!foundAny) {
        container.innerHTML = '<em>No data found.</em>';
      }
    }

    function renderPhase2() {
      const data = JSON.parse(sessionStorage.getItem('phase3_ranking') || getCookie('phase3_ranking') || '{}');
      const container = document.getElementById('phase2');
      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<em>No data found.</em>';
        return;
      }
      Object.entries(data).forEach(([rank, ids]) => {
        container.innerHTML += `<p><strong>Position ${rank}:</strong> ${ids.map(id => id.replace('snippet-', '')).join(', ')}</p>`;
      });
    }

    function renderPhase3() {
      const data = JSON.parse(sessionStorage.getItem('phase3_reasoning') || '{}');
      const container = document.getElementById('phase3');
      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<em>No data found.</em>';
        return;
      }
      Object.entries(data).forEach(([key, answer], i) => {
        container.innerHTML += `<p><strong>Q${i + 1}:</strong> ${answer}</p>`;
      });
    }

  function submitAll() {
    const name = sessionStorage.getItem('participantName') || getCookie('participantName') || 'Anonymous';
    const phase1 = {}; // Construct phase1 data from cookies/session
    for (let i = 1; i <= 8; i++) {
      const summary = sessionStorage.getItem(`summary${i}`) || getCookie(`summary${i}`) || '';
      const comp = sessionStorage.getItem(`compSummary${i}`) || getCookie(`compSummary${i}`) || '';
      phase1[`snippet${i}`] = { summary, comprehensibility: comp };
    }

    const phase2 = JSON.parse(sessionStorage.getItem('phase3_ranking') || '{}');
    const phase3 = JSON.parse(sessionStorage.getItem('phase3_reasoning') || '{}');

    const payload = { name, phase1, phase2, phase3 };

    fetch('https://codecomprehensibility.site/submit_final', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
      .then(res => res.ok ? alert('‚úÖ Submission successful!') : alert('‚ùå Submission failed.'))
      .catch(() => alert('‚ö†Ô∏è Error during submission.'));
  }


    renderPhase1();
    renderPhase2();
    renderPhase3();
  </script>

  <script>
    window.onload = () => {
      displayUserName();
      if (sessionStorage.getItem('phase1Complete') === 'true') {
        document.getElementById('link-phase2')?.classList.remove('disabled');
      }
      if (sessionStorage.getItem('phase2Complete') === 'true') {
        document.getElementById('link-phase3')?.classList.remove('disabled');
      }
      if (sessionStorage.getItem('phase3Complete') === 'true') {
        document.getElementById('link-review')?.classList.remove('disabled');
      }

      // Mark current phase active
      document.getElementById('link-review')?.classList.add('active');
    };
  </script>

<script>
  function displayUserName() {
    const name = sessionStorage.getItem('participantName') || getCookie('participantName');
    if (name) {
      document.getElementById('user-info').textContent = `üë§ ${name}`;
    }
  }
</script>
</body>
</html>
